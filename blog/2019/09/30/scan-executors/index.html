<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" integrity="sha384-h21C2fcDk/eFsW9sC9h0dhokq5pDinLNklTKoxIZRUn3+hvmgQSffLLQ4G4l2eEr" crossorigin="anonymous">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/fluo.css">
    <link rel="canonical" href="https://fluo.apache.org//blog/2019/09/30/scan-executors/">
    <link rel="icon" type="image/png" href="/resources/favicon.png">
    
    <title>How Fluo Leveraged Scan Executors | Apache Fluo</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <!-- Place your <script> tags here. -->

<script>window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));</script>

  </head>
  <body style="padding-top: 100px">
    <nav id="fluo-nav" class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <div class="navbar-toggle-wrapper visible-xs">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".js-navbar-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
          </div>
          <a href="/" class="navbar-brand"><img id="fluo-img" height="40px" src="/resources/fluo-logo-dark.png" alt="Apache Fluo"></a>
        </div>
        <div class="collapse navbar-collapse js-navbar-collapse" style="margin-top: 20px">
          <ul class="navbar-nav nav">
            <li><a href="/releases/">Releases</a></li>
            <li><a href="/tour/">Tour</a></li>
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#">Docs<span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="/docs/fluo/1.2/">Fluo</a></li>
                <li><a href="/docs/fluo-recipes/1.2/">Fluo Recipes</a></li>
              </ul>
            </li>
            <li><a href="/api/">API</a></li>
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#">Community<span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="/contactus/">Contact Us</a></li>
                <li><a href="/news/">News Archive</a></li>
                <li><a href="/people/">People</a></li>
                <li><a href="/related-projects/">Related Projects</a></li>
                <li><a href="/poweredby/">Powered By</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#">Contributing<span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="/how-to-contribute/">How To Contribute</a></li>
                <li><a href="/release-process/">Release Process</a></li>
              </ul>
            </li>
            <li><a href="/search/">Search</a></li>
          </ul>
          <ul class="navbar-nav nav navbar-right">
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#"><img alt="Apache Software Foundation" src="https://www.apache.org/images/feather-small.png" width="70"/><span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="https://www.apache.org">Apache Homepage</a></li>
                <li><a href="https://www.apache.org/licenses/">License</a></li>
                <li><a href="https://www.apache.org/foundation/sponsorship">Sponsorship</i></a></li>
                <li><a href="https://www.apache.org/security">Security</a></li>
                <li><a href="https://www.apache.org/foundation/thanks">Thanks</a></li>
                <li><a href="https://www.apache.org/foundation/policies/conduct">Code of Conduct</a></li>
                <li><a href="https://www.apache.org/events/current-event.html">Current Event</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container">
      <div class="row">
          <div class="col-sm-12">
            <div id="post-header">
  <h1>How Fluo Leveraged Scan Executors</h1>
  <p class="text-muted">
     Author : Keith Turner <br>  
    
    30 Sep 2019
  </p> 
  <p><a class="twitter-share-button" href="https://twitter.com/intent/tweet?text=How Fluo Leveraged Scan Executors&url=https://fluo.apache.org//blog/2019/09/30/scan-executors/&via=ApacheFluo&related=ApacheFluo" rel="nofollow" target="_blank" title="Share on Twitter">Twitter</a></p>
</div>
<div id="post-content">
  <p>Accumulo 2.0 introduced <a href="https://accumulo.apache.org/docs/2.x/administration/scan-executors">Scan Executors</a> giving control over processing of
scans in Accumulo tablet servers. Fluo has a good use case for scan executors:
notification scans.  Fluo workers continually scan for notifications to find
transactions to execute. All workers continually scanning for notifications
puts load on Accumulo tablet servers which could negatively impact
transactions.  Scan executors provides a way to limit this load.</p>

<p>Fluo utilizes this feature by <a href="https://github.com/apache/fluo/blob/57b154e13c5c0877bb565fcabf620aa0f30c9f24/modules/core/src/main/java/org/apache/fluo/core/worker/finder/hash/ScanTask.java#L197">setting scan hints</a> for notification scans
indicating <code class="highlighter-rouge">scan_type=fluo-ntfy</code>.  These hints are passed to Accumulo tablet
servers and are ignored by default. For these scan types, Accumulo could be
configured to either send them to a special thread pool and/or prioritize them
differently within a thread pool.  Below is an example of Accumulo shell
commands that set up a special executor for notification scans.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config -s tserver.scan.executors.fnotify.threads=1
config -t fluo_table -s table.scan.dispatcher=org.apache.accumulo.core.spi.scan.SimpleScanDispatcher
config -t fluo_table -s table.scan.dispatcher.opts.executor.fluo-ntfy=fnotify
</code></pre></div></div>

<p>The system setting <code class="highlighter-rouge">tserver.scan.executors.fnotify.threads=1</code> creates a single-threaded
scan executor in each tablet server named <code class="highlighter-rouge">fnotify</code>. The two per-table
settings configure a scan dispatcher (the <code class="highlighter-rouge">SimpleScanDispatcher</code> is built into
Accumulo) on the table <code class="highlighter-rouge">fluo_table</code>.  The scan dispatcher is configured such that when
a scan hint of <code class="highlighter-rouge">scan_type=fluo-ntfy</code> is seen, it runs on the executor <code class="highlighter-rouge">fnotify</code>.
All other scans will run on the default executor. This has the effect running
all notification scans on a single dedicated thread in each tablet server.</p>

<p>The above setting were tested in a scenario where 20 Fluo worker were run
against a single tablet server with 20 tablets.  The Fluo stress test was run
with a low ingest rate, resulting in continual notification scanning by the 20
workers.  While the test was running, <code class="highlighter-rouge">jstack</code> and <code class="highlighter-rouge">top</code> were used to inspect the
tablet server. This inspection revealed that notification scans were all
running in a single thread which was using 100% of a single core.  This left all
of the other cores free to process transactions.  Further testing to see how
this impacts throughput is needed. Observing the worker debug logs, all of them
seemed to complete notification scans, quickly finding new work.</p>

<p>Fluo took a descriptive approach to using scan hints, where it described to Accumulo
the type of scan it was running.  However, Fluo does not care what, if
anything, Accumulo does with that information.  This allows administrators to
configure Accumulo in many different ways to handle notification scans, without
any changes to Fluo.</p>

<p>For my first pass at using scan executors, I tried a prescriptive approach. I
attempted to use scan hints to explicitly name an executor for notification
scans.  I realized this would require Fluo configuration to provide the name of
the scan executor. Forcing a user to specify Accumulo and Fluo configuration
was very cumbersome so I abandoned the prescriptive approach.  The descriptive
approach I settled on in its place is less cumbersome (it only requires Accumulo
config) and more flexible (it supports executors and/or prioritization instead
of only executors).</p>

<p>At the time of this writing, no released version of Fluo supports Accumulo 2.0.
Once Fluo 1.3.0 is released with Accumulo 2.0, Hadoop 3.0, and Java 11 support,
it will include support for scan executors.</p>


</div>

<div>
  <p class="text-muted">View all posts in the <a href="/news/">news archive</a></p>
</div>

          </div>
      </div>
      <div class="row">
        <div class="col-sm-12 center-block">
          <footer>
            <hr/>
            <p>
            <a href="https://www.apache.org/foundation/contributing"><img
              src="https://www.apache.org/images/SupportApache-small.png"
              id="asf-logo" height="100" alt="Apache"/></a>
            </p>
            <p>
            Copyright &copy; 2020 <a
              href="https://www.apache.org">The&nbsp;Apache&nbsp;Software&nbsp;Foundation</a>.
            Licensed under the <a
              href="https://www.apache.org/licenses/">Apache&nbsp;License,&nbsp;Version&nbsp;2.0</a>
            </p>
            <p>
            Apache®, the names of Apache projects and their logos, and the multicolor feather
            logo are registered trademarks or trademarks of The Apache Software Foundation
            in the United States and/or other countries.
            </p>
          </footer>
        </div>
      </div>
    </div>
  </body>
</html>
